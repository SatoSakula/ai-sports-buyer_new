<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>AI 场景化运动装备导购助手</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
/* =========================================================
   iOS Design Tokens
   ========================================================= */
:root {
  --ios-bg: #f2f2f7;
  --ios-card: #ffffff;
  --ios-divider: rgba(60, 60, 67, 0.12);

  --ios-blue: #007aff;
  --ios-green: #34c759;
  --ios-red: #ff3b30;

  --ios-text-primary: #1c1c1e;
  --ios-text-secondary: #6e6e73;

  --ios-radius: 14px;
}

/* =========================================================
   Global
   ========================================================= */
* {
  box-sizing: border-box;
}

body {
  margin: 0;
  height: 100vh;
  font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text",
               "Helvetica Neue", sans-serif;
  background: var(--ios-bg);
  display: flex;
  flex-direction: column;
  color: var(--ios-text-primary);
}

/* =========================================================
   Header (iOS Navigation Bar)
   ========================================================= */
.app-header {
  height: 56px;
  background: rgba(255, 255, 255, 0.8);
  backdrop-filter: saturate(180%) blur(20px);
  border-bottom: 1px solid var(--ios-divider);
  display: flex;
  align-items: center;
  padding: 0 16px;
  font-weight: 600;
}

.header-left {
  font-size: 15px;
  white-space: nowrap;
}

/* ===== Header Title – GPT Style ===== */
.header-left {
  font-family: -apple-system, BlinkMacSystemFont,
               "SF Pro Display", "Helvetica Neue", sans-serif;
  font-size: 16px;
  font-weight: 700;
  letter-spacing: 0.4px;
  color: #5b8cff; /* GPT 风格浅蓝 */
}

.header-center {
  flex: 1;
}

.header-right input {
  height: 32px;
  font-size: 13px;
  padding: 0 10px;
  border-radius: 8px;
  border: 1px solid var(--ios-divider);
  background: #fff;
  color: var(--ios-text-primary);
}

/* ===== Header User Icon (GPT Style) ===== */
.header-right {
  position: relative;
}

/* 用户简笔画图标 */
.header-right::before {
  content: "";
  position: absolute;
  left: 10px;
  top: 50%;
  transform: translateY(-50%);
  width: 16px;
  height: 16px;
  opacity: 0.6;

  /* 用 CSS 画一个简笔 user icon */
  background:
    radial-gradient(circle at 50% 30%, #8fa8ff 35%, transparent 36%) ,
    radial-gradient(circle at 50% 85%, #8fa8ff 55%, transparent 56%);
  background-size: 100% 100%;
  background-repeat: no-repeat;
}

/* 给 input 留出图标空间 */
.header-right input {
  padding-left: 34px; /* 原来是 10px，这里往右推 */
}


/* =========================================================
   Layout
   ========================================================= */
.layout {
  flex: 1;
  display: flex;
  overflow: hidden;
}

/* =========================================================
   Action Panel (iOS Settings style)
   ========================================================= */
.action-panel {
  width: 300px;
  background: var(--ios-bg);
  border-right: 1px solid var(--ios-divider);
  display: flex;
  flex-direction: column;
}

.action-header {
  padding: 14px 16px;
  font-size: 14px;
  font-weight: 600;
}

.action-count {
  background: var(--ios-green);
  color: #fff;
  font-size: 12px;
  padding: 2px 8px;
  border-radius: 999px;
}

/* Segmented Control */
.action-tabs {
  display: flex;
  background: #e5e5ea;
  border-radius: 10px;
  padding: 2px;
  margin: 8px;
}

.action-tabs button {
  flex: 1;
  border: none;
  background: transparent;
  border-radius: 8px;
  padding: 6px 0;
  font-size: 12px;
  color: var(--ios-text-secondary);
  cursor: pointer;
}

.action-tabs button.active {
  background: #ffffff;
  color: var(--ios-text-primary);
  box-shadow: 0 1px 2px rgba(0,0,0,0.08);
}

.product-list {
  flex: 1;
  overflow-y: auto;
  padding: 12px;
}

/* =========================================================
   Product Card (iOS Card)
   ========================================================= */
.product-card {
  background: var(--ios-card);
  border-radius: var(--ios-radius);
  padding: 12px;
  margin-bottom: 12px;
  font-size: 13px;
  box-shadow:
    0 1px 2px rgba(0,0,0,0.04),
    0 6px 16px rgba(0,0,0,0.06);
  transition: transform 0.15s ease;
}

.product-card:active {
  transform: scale(0.98);
}

.product-img {
  width: 100%;
  height: 120px;
  background: #e5e5ea;
  border-radius: 10px;
  margin-bottom: 8px;
  background-size: cover;
  background-position: center;
}

.product-name {
  font-weight: 600;
  margin-bottom: 4px;
}

.product-cat {
  font-size: 12px;
  color: var(--ios-text-secondary);
  margin-bottom: 6px;
}

.product-reason {
  font-size: 13px;
  color: var(--ios-text-secondary);
  margin-bottom: 10px;
}

.product-actions {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

/* =========================================================
   Buttons (iOS semantic)
   ========================================================= */
.product-actions button {
  border: none;
  font-size: 13px;
  padding: 8px 14px;
  border-radius: 999px;
  cursor: pointer;
  font-weight: 600;
}

/* Primary */
.btn-view {
  background: var(--ios-blue);
  color: #fff;
}

/* Success */
.btn-own {
  background: var(--ios-green);
  color: #fff;
}

.btn-own.owned {
  background: #d1d1d6;
  pointer-events: none;
}

/* Destructive */
.btn-dismiss {
  background: transparent;
  color: var(--ios-red);
  padding: 0;
}

.btn-dismiss:active {
  opacity: 0.6;
}

/* =========================================================
   Chat Panel (iMessage style)
   ========================================================= */
.chat-panel {
  flex: 1;
  display: flex;
  flex-direction: column;
}

.chat-messages {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
}

.msg {
  display: inline-block;
  width: fit-content;
  max-width: 78%;
  padding: 12px 16px;
  border-radius: 22px;
  margin-bottom: 14px;
  line-height: 1.55;
  white-space: pre-wrap;
  font-size: 15px;
  word-break: break-word;
  clear: both;
}

.msg.user {
  float:right;
  background: rgba(120, 150, 220, 0.85);
  color: #fff;
  margin-left: auto;
  box-shadow: 0 6px 18px rgba(0,0,0,0.18);
}

.msg.ai {
  float:left;
  background: rgba(255,255,255,0.9);
  color: var(--text-main);
  box-shadow: 0 4px 14px rgba(0,0,0,0.12);
}

.msg.ai.compare-msg {
  max-width: 100%;
}

/* =========================================================
   Chat Input
   ========================================================= */
.chat-input {
  display: flex;
  padding: 12px;
  border-top: 1px solid var(--ios-divider);
  background: rgba(255,255,255,0.9);
  backdrop-filter: blur(20px);
  gap: 8px;
}

textarea {
  flex: 1;
  resize: none;
  border-radius: 18px;
  border: 1px solid var(--ios-divider);
  padding: 10px 14px;
  font-size: 14px;
}

button.send {
  border: none;
  padding: 0 20px;
  border-radius: 999px;
  background: linear-gradient(135deg, #7aa2e3, #9b8fdc);
  color: #fff;
  font-weight: 600;
  box-shadow: 0 6px 16px rgba(0,0,0,0.2);
}

/* =========================================================
   Compare Panel (iOS Sheet style)
   ========================================================= */
.compare-panel {
  background: #ffffff;
  border-radius: 18px;
  padding: 14px;
  margin-top: 6px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.12);
}

.compare-cards {
  display: flex;
  gap: 12px;
  overflow-x: auto;
}

.compare-card {
  min-width: 200px;
  background: #f2f2f7;
  border-radius: 14px;
  padding: 12px;
  position: relative;
}

.compare-card.selected {
  background: rgba(0,122,255,0.12);
  border: 1px solid var(--ios-blue);
}

.compare-card .name {
  font-size: 14px;
  font-weight: 600;
}

.compare-card .cat {
  font-size: 12px;
  color: var(--ios-text-secondary);
}

.compare-footer {
  margin-top: 10px;
  display: flex;
  justify-content: space-between;
}

.compare-footer button {
  background: var(--ios-blue);
  color: #fff;
  border: none;
  border-radius: 999px;
  padding: 8px 18px;
  font-weight: 600;
}

/* =========================================================
   Unified Gradient Button System
   ========================================================= */

/* 主行动（查看 / 对比 / 发送） */
.btn-view,
.compare-footer button {
  background: linear-gradient(135deg, #7aa2e3, #9b8fdc);
  color: #fff;
  font-weight: 600;
  border-radius: 999px;
  box-shadow: 0 6px 16px rgba(0,0,0,0.2);
}

/* 已拥有（状态确认） */
.btn-own {
  background: linear-gradient(135deg, #34c759, #6dd5a3);
  color: #fff;
  font-weight: 600;
  border-radius: 999px;
  box-shadow: 0 4px 12px rgba(52,199,89,0.35);
}

/* 已拥有不可再点 */
.btn-own.owned {
  filter: grayscale(0.3) brightness(0.95);
  pointer-events: none;
}

/* 不感兴趣（否定实体按钮） */
.btn-dismiss {
  background: linear-gradient(135deg, #ff6b6b, #ff9f7f);
  color: #fff;
  font-weight: 600;
  padding: 8px 14px;
  border-radius: 999px;
  box-shadow: 0 4px 12px rgba(255,107,107,0.35);
}

/* 统一交互反馈 */
.btn-view:hover,
.btn-own:hover,
.btn-dismiss:hover,
.compare-footer button:hover {
  filter: brightness(1.05);
}

.btn-view:active,
.btn-own:active,
.btn-dismiss:active,
.compare-footer button:active {
  transform: scale(0.96);
}

/* =========================================================
   Favorite Star – Card Top Right
   ========================================================= */

/* 卡片作为定位容器 */
.product-card {
  position: relative;
}

/* 星号基础样式 */
.product-card .star {
  position: absolute;
  top: 14px;              /* 与标题视觉齐平 */
  right: 14px;
  font-size: 18px;
  cursor: pointer;
  color: #9ca3af;         /* 默认灰 */
  transition: transform 0.15s ease, color 0.15s ease;
}

/* hover 反馈 */
.product-card .star:hover {
  transform: scale(1.15);
}

/* 已收藏：实心黄色星星 */
.product-card .star.filled {
  color: #facc15;         /* iOS / GPT 风黄色 */
}

/* 可选：已收藏时更“稳”一点 */
.product-card .star.filled:hover {
  transform: scale(1.2);
}

</style>

</head>

<body>

<header class="app-header">
  <div class="header-left">
    AI 场景化运动装备导购助手
  </div>

  <div class="header-center"></div>

  <div class="header-right">
    <input
      id="userIdInput"
      placeholder="user_id"
      title="用户 ID"
    />
  </div>
</header>


<div class="layout">

<!-- 行动包 -->
<aside class="action-panel">
  <div class="action-header">
    行动包 <span class="action-count" id="actionCount">0</span>
  </div>
  <div class="action-tabs">
    <button class="active" onclick="switchTab('all')">全部推荐</button>
    <button onclick="switchTab('fav')">收藏</button>
    <button onclick="switchTab('own')">已拥有</button>
  </div>
  <div class="product-list" id="productList">
    <div style="color:#999;font-size:12px;">等待 AI 推荐…</div>
  </div>
</aside>

<!-- 聊天 -->
<main class="chat-panel">
  <div class="chat-messages" id="chatMessages"></div>
  <div class="chat-input">
    <textarea id="input" rows="1" placeholder="描述你的运动需求…"></textarea>
    <button class="send" onclick="send()">发送</button>
  </div>
</main>

</div>

<script>
const API_URL = "http://localhost:8000/chat";
const userIdInput = document.getElementById("userIdInput");

// 从 localStorage 读取
let USER_ID = localStorage.getItem("user_id") || "";

// 初始化输入框
if (USER_ID) {
  userIdInput.value = USER_ID;
}

// 用户修改时保存
userIdInput.addEventListener("change", () => {
  USER_ID = userIdInput.value.trim();
  if (USER_ID) {
    localStorage.setItem("user_id", USER_ID);
  }
});


const chat = document.getElementById("chatMessages");
const productList = document.getElementById("productList");
const input = document.getElementById("input");
const actionCount = document.getElementById("actionCount");

let sessionId = null;
let currentTab = "all";

let allProducts = {};
let favorites = new Set();
let owned = new Set();
let compareSet = new Set();

/* ===== raw JSON 兜底 ===== */
function tryParseProductJSON(text) {
  if (!text) return null;
  const cleaned = text.replace(/```json|```/g, "").trim();
  try {
    const obj = JSON.parse(cleaned);
    return Array.isArray(obj.items) ? obj : null;
  } catch {
    return null;
  }
}

function renderMarkdown(text) {
  if (!text) return "";

  return text
    // 标题行（单独一行的 **xxx**）
    .replace(/^\*\*(.*?)\*\*$/gm, "<div class='ai-title'>$1</div>")

    // **加粗**
    .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")

    // 列表
    .replace(/^\s*-\s+(.*)$/gm, "<div class='ai-bullet'>• $1</div>")

    // 换行
    .replace(/\n/g, "<br/>");
}

/* ===== 聊天 ===== */
function addMsg(role, text = "") {
  const div = document.createElement("div");
  div.className = "msg " + role;
  div.textContent = text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
  return div;
}

/* ===== 工具：更新所有对比计数（避免多个 compareCount id 冲突） ===== */
function updateCompareCounts() {
  document.querySelectorAll('[data-role="compareCount"]').forEach(el => {
    el.textContent = String(compareSet.size);
  });
}

/* ===== 聊天内对比区 ===== */
function addComparePanel(items) {
  const msg = document.createElement("div");
  msg.className = "msg ai compare-msg";

  msg.innerHTML = `
    <div class="compare-panel">
      <div class="compare-cards">
        ${items.map(i => `
          <div class="compare-card" data-id="${i.id}">
            <div class="name">${i.name}</div>
            <div class="cat">${i.category || ""}</div>
            <button onclick="toggleCompare('${i.id}', this)">＋</button>
          </div>
        `).join("")}
      </div>
      <div class="compare-footer">
        <div>已选择 <b data-role="compareCount">0</b> 个商品</div>
        <button onclick="sendCompare()">对比商品</button>
      </div>
    </div>
  `;
  chat.appendChild(msg);
  chat.scrollTop = chat.scrollHeight;

  // 初始化一次计数
  updateCompareCounts();
}

function toggleCompare(id, btn) {
  const card = btn.parentElement;
  if (compareSet.has(id)) {
    compareSet.delete(id);
    btn.textContent = "＋";
    card.classList.remove("selected");
  } else {
    compareSet.add(id);
    btn.textContent = "✓";
    card.classList.add("selected");
  }
  updateCompareCounts();
}

/* ===== 修复后的 sendCompare：真正走 SSE 流式读取 ===== */
async function sendCompare() {
  const compareSelection = Array.from(compareSet); //
    if (!USER_ID) {
      alert("请先输入 user_id（用于个性化推荐）");
      return;
    }

  if (compareSelection.length < 2) {
    alert("至少选择两个商品进行对比");
    return;
  }

  // 组装 payload（必须和后端 is_compare_payload 对齐）
  const payload = {
    intent: "compare_products",
    items: compareSelection.map(id => {
      const p = allProducts[id];
      return {
        id: p?.id || id,
        name: p?.name || "",
        brand: p?.brand || "",
        category: p?.category || "",
        reason: p?.reason || ""
      };
    })
  };

  // 在聊天区显示用户动作
  addMsg("user", "帮我对比这几个商品");

  // AI 思考气泡（保留点点点）
  const aiMsg = addMsg("ai", "AI 正在思考");
  let dots = 0;
  let hasStarted = false;

  const loadingTimer = setInterval(() => {
    if (!hasStarted) {
      aiMsg.textContent = "AI 正在思考" + ".".repeat((dots++ % 3) + 1);
    }
  }, 400);

  // 发起 SSE 请求（关键：必须读取 res.body 才会“有反应”）
  const res = await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      user_id: USER_ID,
      session_id: sessionId,
      message: JSON.stringify(payload)
    })
  });

  if (!res.ok || !res.body) {
    clearInterval(loadingTimer);
    aiMsg.textContent = `对比请求失败：HTTP ${res.status}`;
    return;
  }

  const reader = res.body.getReader();
  const decoder = new TextDecoder();
  let buffer = "";

  // 真正开始流式接收
  while (true) {
    const { value, done } = await reader.read();
    if (done) break;

    buffer += decoder.decode(value, { stream: true });
    const events = buffer.split("\n\n");
    buffer = events.pop();

    for (const evt of events) {
      if (!evt.startsWith("data:")) continue;

      let obj = null;
      try {
        obj = JSON.parse(evt.replace(/^data:\s*/, ""));
      } catch (e) {
        continue;
      }

      // 会话 id
      if (obj.session_id) sessionId = obj.session_id;

      // 第一段内容到达后，停止 loading
      if (!hasStarted) {
        clearInterval(loadingTimer);
        aiMsg.textContent = "";
        hasStarted = true;
      }

      // 后端可能返回：product_compare / final_recommendation / text
      if (obj.type === "product_compare") {
        const data = obj.data || {};
        const focus = data.focus ? `关注点：${data.focus}\n\n` : "";
        const items = Array.isArray(data.items) ? data.items : [];

        const lines = items.map(it => {
          const name = it.name || "未命名产品";
          const pros = Array.isArray(it.pros) ? it.pros.join("、") : "";
          const cons = Array.isArray(it.cons) ? it.cons.join("、") : "";
          return `【${name}】\n优点：${pros || "—"}\n限制：${cons || "—"}`;
        }).join("\n\n");

        const suggestion = data.suggestion ? `\n\n建议：${data.suggestion}` : "";
        aiMsg.textContent += focus + lines + suggestion;
        chat.scrollTop = chat.scrollHeight;
        continue;
      }

      if (obj.type === "final_recommendation") {
        const data = obj.data || {};
        const pick = data.pick ? `最终推荐：${data.pick}` : "最终推荐：—";
        const why = Array.isArray(data.why) ? `原因：${data.why.join("；")}` : "";
        const next = data.next ? `下一步：${data.next}` : "";
        aiMsg.textContent += `\n\n${pick}\n${why}${next ? "\n" + next : ""}`;
        chat.scrollTop = chat.scrollHeight;
        continue;
      }

      if (obj.type === "text") {
        const t = obj?.data?.text || "";
        aiMsg.textContent += t;
        chat.scrollTop = chat.scrollHeight;
        continue;
      }
    }
  }

  clearInterval(loadingTimer);
}

function tryParseLLMJson(text) {
  if (!text) return null;

  const cleaned = text
    .replace(/```json|```/g, "")
    .trim();

  try {
    const obj = JSON.parse(cleaned);
    return obj && typeof obj === "object" ? obj : null;
  } catch {
    return null;
  }
}

function renderStructuredResponse(obj, aiMsg) {
  if (obj.type === "product_compare") {
    const data = obj.data || {};
    const focus = data.focus ? `关注点：${data.focus}\n\n` : "";
    const items = Array.isArray(data.items) ? data.items : [];

    const lines = items.map(it => {
      return `【${it.name}】\n优点：${(it.pros || []).join("、") || "—"}\n限制：${(it.cons || []).join("、") || "—"}`;
    }).join("\n\n");

    const suggestion = data.suggestion ? `\n\n建议：${data.suggestion}` : "";
    aiMsg.textContent += focus + lines + suggestion;
    return true;
  }

  if (obj.type === "final_recommendation") {
    const data = obj.data || {};
    aiMsg.textContent += `\n\n最终推荐：${data.pick || "—"}\n原因：${(data.why || []).join("；")}`;
    if (data.next) aiMsg.textContent += `\n下一步：${data.next}`;
    return true;
  }

  return false;
}


/* ===== 行动包（与你原来一致） ===== */
function switchTab(tab) {
  currentTab = tab;
  document.querySelectorAll(".action-tabs button").forEach(btn => {
    btn.classList.toggle("active", btn.textContent.includes(
      tab === "all" ? "全部" : tab === "fav" ? "收藏" : "已拥有"
    ));
  });
  renderProducts();
}

function removeProduct(id) {
  delete allProducts[id];
  favorites.delete(id);
  owned.delete(id);
  compareSet.delete(id);
  renderProducts();
  updateCompareCounts();
}

function toggleFav(id) {
  favorites.has(id) ? favorites.delete(id) : favorites.add(id);
  renderProducts();
}

function markOwned(id) {
  owned.add(id);
  favorites.delete(id);
  renderProducts();
}

function renderProducts() {
  productList.innerHTML = "";
  let items = Object.values(allProducts);
  if (currentTab === "fav") items = items.filter(i => favorites.has(i.id));
  if (currentTab === "own") items = items.filter(i => owned.has(i.id));

  if (!items.length) {
    productList.innerHTML = `<div style="color:#999;font-size:12px;">暂无商品</div>`;
  }

  items.forEach(item => {
    const fav = favorites.has(item.id);
    const card = document.createElement("div");
    card.className = "product-card";
    card.innerHTML = `
      <div class="product-name">${item.name}</div>
      <div class="product-cat">${item.category || ""}</div>
      <div class="product-reason">${item.reason || ""}</div>

      <div class="product-actions">
          <button class="btn-view" onclick="openProduct('${item.id}')">查看</button>

          <span class="star ${fav ? "filled" : ""}"
                onclick="toggleFav('${item.id}')">
            ${fav ? "★" : "☆"}
          </span>

          <button class="btn-own ${owned.has(item.id) ? 'owned' : ''}"
                  onclick="markOwned('${item.id}')">
            ${owned.has(item.id) ? '已拥有' : '标记已拥有'}
          </button>

          <button class="btn-dismiss"
                  onclick="removeProduct('${item.id}')">
            不感兴趣
          </button>
        </div>
    `;
    productList.appendChild(card);
  });

  actionCount.textContent = Object.keys(allProducts).length;
}

function openProduct(id) {
  const item = allProducts[id];
  const q = encodeURIComponent(item.search_hint || item.name);
  const link = item.official_site
    ? item.official_site.replace(/\/$/, "") + "/search?q=" + q
    : "https://www.google.com/search?q=" + encodeURIComponent(item.name);
  window.open(link, "_blank");
}

/* ===== 发送（保留动态思考） ===== */
input.addEventListener("keydown", e => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    send();
  }
});

async function send() {
  const text = input.value.trim();
    if (!USER_ID) {
      alert("请先输入 user_id（用于个性化推荐）");
      return;
    }

  if (!text) return;

  input.value = "";
  addMsg("user", text);

  const aiMsg = addMsg("ai", "AI 正在思考");
  let dots = 0;
  let hasStarted = false;

  const loadingTimer = setInterval(() => {
    if (!hasStarted) {
      aiMsg.textContent = "AI 正在思考" + ".".repeat((dots++ % 3) + 1);
    }
  }, 400);

  const res = await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ user_id: USER_ID, message: text, session_id: sessionId })
  });

  const reader = res.body.getReader();
  const decoder = new TextDecoder();
  let buffer = "";

  aiMsg.textContent = "";

  while (true) {
    const { value, done } = await reader.read();
    if (done) break;

    buffer += decoder.decode(value, { stream: true });
    const events = buffer.split("\n\n");
    buffer = events.pop();

    for (const evt of events) {
      if (!evt.startsWith("data:")) continue;
      const obj = JSON.parse(evt.replace(/^data:\s*/, ""));
      if (obj.session_id) sessionId = obj.session_id;

        if (obj.type === "text") {
          if (!hasStarted) {
            clearInterval(loadingTimer);
            aiMsg.textContent = "";
            hasStarted = true;
          }

          const rawText = obj?.data?.text || "";

          // ① 兜底：尝试解析 LLM 包在 text 里的 JSON
          const parsedJson = tryParseLLMJson(rawText);

          // ② 如果解析成功，并且是结构化 compare / final
          if (parsedJson && parsedJson.type) {
            const handled = renderStructuredResponse(parsedJson, aiMsg);
            if (handled) {
              chat.scrollTop = chat.scrollHeight;
              continue;
            }
          }

          // ③ 再尝试你原来的 product list JSON
          const parsedProducts = tryParseProductJSON(rawText);
          if (parsedProducts) {
            if (parsedProducts.summary) aiMsg.textContent += parsedProducts.summary + "\n";
            parsedProducts.items.forEach(i => allProducts[i.id] = i);
            renderProducts();
            addComparePanel(parsedProducts.items);
          } else {
            // ④ 最终兜底：普通文本
            aiMsg.innerHTML += renderMarkdown(rawText);
          }

          chat.scrollTop = chat.scrollHeight;
        }

      if (obj.type === "product_list") {
        clearInterval(loadingTimer);
        obj.data.items.forEach(i => allProducts[i.id] = i);
        renderProducts();
        addComparePanel(obj.data.items);
      }
    }
  }

  clearInterval(loadingTimer);
}
</script>

</body>
</html>
